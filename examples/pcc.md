# Posterior Predictive Checks with ``EMModel``

This example demonstrates how to run posterior predictive checks (PPCs) using
the simple Rescorla–Wagner (``rw1a1b``) reinforcement learning model. We will:

1. Simulate synthetic data.
2. Fit the hierarchical EM model.
3. Run PPCs on both the percentage of option ``A`` choices and the observed
   rewards.
4. Visualize the diagnostics using :meth:`EMModel.plot_pcc`.

```python
import numpy as np
from pyem.api import EMModel
from pyem.models.rl import rw1a1b_fit, rw1a1b_simulate

# Step 1: simulate a small cohort
nsubjects, nblocks, ntrials = 10, 3, 24
true_params = np.column_stack([
    np.random.randn(nsubjects),  # inverse temperature (Gaussian space)
    np.random.randn(nsubjects),  # learning rate    (Gaussian space)
])
sim_data = rw1a1b_simulate(true_params, nblocks=nblocks, ntrials=ntrials)
all_data = [[c, r] for c, r in zip(sim_data["choices"], sim_data["rewards"])]

# Step 2: fit the hierarchical EM model
model = EMModel(
    all_data=all_data,
    fit_func=rw1a1b_fit,
    param_names=["beta", "alpha"],
    simulate_func=rw1a1b_simulate,
)
model.fit(mstep_maxit=25, verbose=0, njobs=1)

# Step 3: run PPCs for two different outputs
choices_result = model.pcc(
    "choices_A",
    n_sims=200,
    sim_kwargs={"nblocks": nblocks, "ntrials": ntrials},
)
rewards_result = model.pcc(
    "rewards",
    n_sims=200,
    sim_kwargs={"nblocks": nblocks, "ntrials": ntrials},
)

print(f"Choices_A PPC p-value: {choices_result.p_value:.3f}")
print(f"Rewards PPC p-value: {rewards_result.p_value:.3f}")

# Step 4: visualize the PPC diagnostics
fig_choices = model.plot_pcc(choices_result, plot_all_agents=True, show=False)
fig_rewards = model.plot_pcc(rewards_result, agent_index=0, show=False)

fig_choices.suptitle("Posterior Predictive Check — choices_A")
fig_rewards.suptitle("Posterior Predictive Check — rewards")

# Display or save the figures as desired
fig_choices.tight_layout()
fig_rewards.tight_layout()
fig_choices.show()
fig_rewards.show()
```

The first PPC evaluates whether the simulated choice proportions (percentage of
option ``A`` selections) match the observed data. The second PPC assesses the
distribution of rewards. Both calls use the same posterior samples obtained from
``EMModel.fit``; the simulated data are generated by sampling each subject's
parameters from their joint Gaussian posterior and running the supplied
simulation function.

``EMModel.plot_pcc`` produces a three-panel summary:

1. Trial-wise means with uncertainty bands for both the simulated and observed
   data.
2. The distribution of grand-average model predictions with a vertical line for
   the observed mean.
3. Optional agent-level scatter plots comparing simulated and observed values
   (all agents or a selected index).

This workflow generalizes to any model that provides both a fitting routine and
a simulation function returning the same keys as requested in ``output='all'``.
